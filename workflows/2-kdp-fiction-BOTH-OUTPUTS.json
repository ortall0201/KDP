{
  "name": "KDP Fiction Generation (BOTH OUTPUTS)",
  "nodes": [
    {
      "parameters": {},
      "id": "1",
      "name": "Start",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [240, 400]
    },
    {
      "parameters": {
        "jsCode": "// EDIT YOUR BOOK CONCEPT HERE\nconst book_concept = \"A forbidden romance between a mortal alchemist who can manipulate metals and a Fae prince exiled from his court. When she accidentally binds his magic to hers, they must work together to break the curse before it kills them both.\";\nconst genre = \"Romance/Fantasy (Romantasy)\";\nconst target_words = 30000; // 15 chapters Ã— 2000 words = 30K\n\nconst timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);\n\nreturn {\n  json: {\n    book_concept: book_concept,\n    genre: genre,\n    target_words: target_words,\n    book_id: timestamp\n  }\n};"
      },
      "id": "2",
      "name": "Set Book Concept",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  model: 'gpt-4o',\n  messages: [\n    {\n      role: 'system',\n      content: 'You are a bestselling fiction author specializing in ' + $json.genre + '. You create compelling stories with strong character development, emotional depth, and page-turning plots.'\n    },\n    {\n      role: 'user',\n      content: 'Create a detailed story outline for a ' + $json.genre + ' novel with this concept:\\n\\n' + $json.book_concept + '\\n\\nProvide:\\n\\n1. MAIN CHARACTERS (3-4 characters)\\n2. SETTING\\n3. PLOT STRUCTURE\\n4. CHAPTER BREAKDOWN (15 chapters with brief scene descriptions)\\n5. KEY THEMES\\n\\nMake it compelling and commercial. This should be a full-length novel with proper pacing.'\n    }\n  ],\n  temperature: 0.8,\n  max_tokens: 3000\n} }}",
        "options": {}
      },
      "id": "3",
      "name": "Generate Outline",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [680, 400]
    },
    {
      "parameters": {
        "jsCode": "// Create 15 chapter items with all needed data (for ~30K word novel)\nconst outline = $input.item.json.choices[0].message.content;\nconst conceptData = $('Set Book Concept').item.json;\n\nconst chapters = [];\nfor (let i = 1; i <= 15; i++) {\n  chapters.push({\n    json: {\n      chapter_number: i,\n      outline: outline,\n      book_concept: conceptData.book_concept,\n      genre: conceptData.genre,\n      book_id: conceptData.book_id\n    }\n  });\n}\n\nreturn chapters;"
      },
      "id": "4",
      "name": "Create Chapter Items",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 400]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {
          "reset": false
        }
      },
      "id": "5",
      "name": "Loop Over Chapters",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [1120, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  model: 'gpt-4o',\n  messages: [\n    {\n      role: 'system',\n      content: 'You are a bestselling ' + $json.genre + ' author. Write vivid, emotionally engaging prose with strong dialogue, sensory details, and compelling character voices.'\n    },\n    {\n      role: 'user',\n      content: 'Write Chapter ' + $json.chapter_number + ' of this ' + $json.genre + ' novel.\\n\\nBOOK CONCEPT: ' + $json.book_concept + '\\n\\nSTORY OUTLINE:\\n' + $json.outline + '\\n\\nREQUIREMENTS:\\n- 2,000-2,500 words minimum (do not write less than 2000 words)\\n- Strong opening hook\\n- Vivid sensory details and descriptions\\n- Natural dialogue with emotional depth\\n- Expand scenes - don\\'t rush through moments\\n- End with a hook\\n\\nWrite the complete chapter now. Make it rich and detailed.'\n    }\n  ],\n  temperature: 0.9,\n  max_tokens: 3500\n} }}",
        "options": {}
      },
      "id": "6",
      "name": "Generate Chapter",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "jsCode": "// Format the chapter and preserve chapter number\nconst chapterNumber = $json.chapter_number;\nconst chapterContent = $input.item.json.choices[0].message.content;\n\nconsole.log(`âœ… Chapter ${chapterNumber} completed (${chapterContent.split(' ').length} words)`);\n\nreturn {\n  json: {\n    chapter_number: chapterNumber,\n    chapter_content: chapterContent\n  }\n};"
      },
      "id": "7",
      "name": "Format Chapter",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "jsCode": "// COMPILE ALL CHAPTERS - This receives data from Split In Batches Output 1 (Done)\nconst allChapters = $input.all();\n\nconsole.log(`\\nðŸŽ‰ DONE OUTPUT FIRED! Received ${allChapters.length} chapters`);\nconsole.log('Chapter numbers:', allChapters.map(ch => ch.json.chapter_number).join(', '));\n\nif (allChapters.length !== 15) {\n  console.error('Expected 15 but got:', allChapters.length);\n  console.error('Data structure:', JSON.stringify(allChapters.slice(0, 2), null, 2));\n  throw new Error(`Expected 15 chapters from Done output, got ${allChapters.length}`);\n}\n\nconst bookData = $('Create Chapter Items').first().json;\n\n// Sort by chapter number\nconst sorted = allChapters.sort((a, b) => a.json.chapter_number - b.json.chapter_number);\n\n// Create title\nconst words = bookData.book_concept.split(' ').slice(0, 5).join(' ');\n\nlet manuscript = `${words}\\nA ${bookData.genre} Novel\\n\\n`;\nmanuscript += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\n\\n`;\nmanuscript += `âš ï¸ AI GENERATED - REQUIRES EDITING\\n\\n`;\nmanuscript += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\n\\n`;\n\nsorted.forEach(item => {\n  manuscript += `\\n\\nCHAPTER ${item.json.chapter_number}\\n\\n`;\n  manuscript += item.json.chapter_content;\n  manuscript += `\\n\\n`;\n});\n\nconst wordCount = manuscript.split(/\\s+/).length;\nconst fileName = `${bookData.book_id}_fiction.txt`;\n\nconsole.log(`ðŸ“š Manuscript compiled: ${wordCount} words across 15 chapters`);\n\nreturn {\n  json: {\n    book_id: bookData.book_id,\n    file_path: `books/manuscripts/${fileName}`,\n    word_count: wordCount,\n    manuscript: manuscript\n  }\n};"
      },
      "id": "8",
      "name": "Compile from Done Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 500]
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "resource": "file",
        "operation": "create",
        "owner": {
          "__rl": true,
          "mode": "list",
          "value": ""
        },
        "repository": {
          "__rl": true,
          "mode": "list",
          "value": ""
        },
        "filePath": "={{ $json.file_path }}",
        "fileContent": "={{ $json.manuscript }}",
        "commitMessage": "=Fiction manuscript: {{ $json.word_count }} words",
        "additionalParameters": {}
      },
      "id": "9",
      "name": "Commit to GitHub",
      "type": "n8n-nodes-base.github",
      "typeVersion": 1,
      "position": [1560, 500]
    }
  ],
  "connections": {
    "Start": {
      "main": [[{"node": "Set Book Concept"}]]
    },
    "Set Book Concept": {
      "main": [[{"node": "Generate Outline"}]]
    },
    "Generate Outline": {
      "main": [[{"node": "Create Chapter Items"}]]
    },
    "Create Chapter Items": {
      "main": [[{"node": "Loop Over Chapters"}]]
    },
    "Loop Over Chapters": {
      "main": [
        [{"node": "Generate Chapter"}],
        [{"node": "Compile from Done Output"}]
      ]
    },
    "Generate Chapter": {
      "main": [[{"node": "Format Chapter"}]]
    },
    "Format Chapter": {
      "main": [[{"node": "Loop Over Chapters"}]]
    },
    "Compile from Done Output": {
      "main": [[{"node": "Commit to GitHub"}]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
